<Project Sdk="Microsoft.NET.Sdk">

  <UsingTask TaskName="DownloadFilesFromUrl" AssemblyFile="$(ToolsDir)Microsoft.DotNet.Build.Tasks.dll"/>

  <PropertyGroup>
    <TargetFramework>netstandard2.0</TargetFramework>
    <IncludeInPackage>Microsoft.ML.DnnImageFeaturizer.ResNet18</IncludeInPackage>
  </PropertyGroup>

  <ItemGroup>
    <ProjectReference Include="..\Microsoft.ML.OnnxTransform\Microsoft.ML.OnnxTransform.csproj" />
  </ItemGroup>

  <PropertyGroup>
    <ModelPlacementDir>$(RepoRoot)bin\obj\DnnImageModels</ModelPlacementDir>
  </PropertyGroup>

  <ItemGroup>
    <PreprocessFile Include="$(ModelPlacementDir)\ResNetPrepOnnx\ResNetPreprocess.onnx"
    Url="https://aka.ms/mlnet-resources/image/ResNetPrepOnnx/ResNetPreprocess.onnx "
    DestinationFile="$(ModelPlacementDir)\ResNetPrepOnnx\ResNetPreprocess.onnx"
    DestinationDir="$(ModelPlacementDir)\ResNetPrepOnnx" />
  </ItemGroup>

  <ItemGroup>
    <ModelFile Include="$(ModelPlacementDir)\ResNet18Onnx\ResNet18.onnx"
    Url="https://aka.ms/mlnet-resources/image/ResNet18Onnx/ResNet18.onnx"
    DestinationFile="$(ModelPlacementDir)\ResNet18Onnx\ResNet18.onnx"
    DestinationDir="$(ModelPlacementDir)\ResNet18Onnx" />
  </ItemGroup>

  <Target Name="DownloadPrepModels" Inputs="@(PreprocessFile)" Outputs="%(PreprocessFile.DestinationFile)">
    <Message Importance="High" Text="Downloading external model files... %(PreprocessFile.DestinationFile)" />
    <MakeDir Directories="$(ModelPlacementDir)" />
    <MakeDir Directories="%(PreprocessFile.DestinationDir)" />
    <DownloadFilesFromUrl Items="@(PreprocessFile)"/>
  </Target>

  <Target Name="DownloadMainModels" 
          DependsOnTargets="DownloadPrepModels"
          AfterTargets="Build"
          Inputs="@(ModelFile)" Outputs="%(ModelFile.DestinationFile)">
    <Message Importance="High" Text="Downloading external model files... %(ModelFile.DestinationFile)" />
    <MakeDir Directories="%(ModelFile.DestinationDir)" />
    <DownloadFilesFromUrl Items="@(ModelFile)"/>
  </Target>

</Project>