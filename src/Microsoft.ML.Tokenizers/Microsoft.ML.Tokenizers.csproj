<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFrameworks>netstandard2.0;net8.0</TargetFrameworks>
    <Nullable>enable</Nullable>
    <IsPackable>true</IsPackable>
    <PackageDescription>Microsoft.ML.Tokenizers contains the implmentation of the tokenization used in the NLP transforms.</PackageDescription>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
  </PropertyGroup>

  <ItemGroup Condition="'$(TargetFramework)' == 'netstandard2.0'">
    <Compile Remove="Utils/Helpers.netcoreapp.cs" />
  </ItemGroup>

  <ItemGroup Condition="'$(TargetFramework)' != 'netstandard2.0'">
    <Compile Remove="Utils/Helpers.netstandard.cs" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="Google.Protobuf" Version="$(GoogleProtobufVersion)" />
    <PackageReference Include="System.Text.Json" Version="$(SystemTextJsonVersion)" />
  </ItemGroup>

  <UsingTask TaskName="CompressFile"
    TaskFactory="RoslynCodeTaskFactory"
    AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll" >
    <ParameterGroup>
      <Files ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System.IO" />
      <Using Namespace="System.IO.Compression" />
      <Code Type="Fragment" Language="cs">
        foreach(var file in Files)
        {
            using var sourceStream = File.OpenRead(file.GetMetadata("FullPath"));
            using var destStream = new DeflateStream(File.Create(file.GetMetadata("Destination")), CompressionLevel.Optimal);
            sourceStream.CopyTo(destStream);
        }
      </Code>
    </Task>
  </UsingTask>

  <ItemGroup>
    <FilesToCompress Include="Data\cl100k_base.tiktoken" Destination="$(IntermediateOutputPath)%(FileName).deflate"
      Source="https://openaipublic.blob.core.windows.net/encodings/cl100k_base.tiktoken" />
    <FilesToCompress Include="Data\gpt2.tiktoken" Destination="$(IntermediateOutputPath)%(FileName).deflate"
      Source="https://pythia.blob.core.windows.net/public/encoding/gpt2.tiktoken" />
    <FilesToCompress Include="Data\p50k_base.tiktoken" Destination="$(IntermediateOutputPath)%(FileName).deflate"
      Source="https://openaipublic.blob.core.windows.net/encodings/p50k_base.tiktoken" />
    <FilesToCompress Include="Data\r50k_base.tiktoken" Destination="$(IntermediateOutputPath)%(FileName).deflate"
      Source="https://openaipublic.blob.core.windows.net/encodings/r50k_base.tiktoken" />
  </ItemGroup>

  <Target Name="TestCompress"
          BeforeTargets="AssignTargetPaths"
          Inputs="@(FilesToCompress)"
          Outputs="@(FilesToCompress->'%(Destination)')">

    <CompressFile Files="@(FilesToCompress)" />
    <ItemGroup>
      <EmbeddedResource Include="@(FilesToCompress->'%(Destination)')" LogicalName="%(FileName)%(Extension).deflate" />
    </ItemGroup>
  </Target>
</Project>
